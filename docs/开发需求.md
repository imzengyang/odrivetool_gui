# ODrive 控制桌面应用 - 产品开发技术文档

## 1. 项目概述

* **应用目标**：开发一个跨平台桌面应用（Windows/Linux/macOS），通过 USB 连接 ODrive v0.5.1 固件的开发板，实现电机配置、控制、实时监控与流程自动化运行。
* **技术栈**：

  * 前端：React + TailwindCSS + TypeScript + Chart.js + React Flow。
  * 桌面壳：Electron。
  * 通信：Node.js + serialport（USB 串口通信），自研 ODrive 协议解析层。

---

## 2. 功能定义

### 2.1 设备连接与管理

* 自动检测 ODrive USB 设备并列出端口。
* 固件版本检查（确认 v0.5.1）。
* 连接/断开控制，连接状态实时显示。
* 设备锁定机制：仅允许单设备运行流程。

### 2.2 电机配置

* 电机参数设置：极对数、Kv、电阻、电感。
* 编码器配置：模式（增量/绝对）、CPR。
* 校准操作：电机校准、编码器校准，执行后提供状态反馈。
* 配置保存/导入导出（JSON 格式）。

### 2.3 电机控制

* 控制模式：位置、速度、电流/力矩。
* UI 控件：滑块、输入框、启用/禁用开关。
* 安全控制：紧急停止按钮（全局快捷键），限速/限流/限压保护。

### 2.4 实时监控与可视化

* 指标：总线电压、电流、转速、温度、控制状态。
* 可视化：Chart.js 折线图，实时刷新，支持暂停/回放。
* 数据管理：环形缓冲（60s 默认，可配置），CSV/JSON 导出。

### 2.5 流程控制（React Flow）

* 流程设计：拖拽节点构建。
* 节点类型：连接、断开、设置参数、校准、状态切换、位置/速度/电流控制、等待、条件分支、循环、记录、导出、错误处理、急停、日志标记。
* 运行控制：运行/暂停/继续/中止。
* 安全机制：运行前安全检查清单。
* 存储：流程保存为 JSON，可导入复用。

---

## 3. 技术方案

### 3.1 架构设计

* **Renderer (前端)**：UI 展示、流程设计与可视化。
* **Main (Electron 主进程)**：

  * 设备检测与串口网关。
  * 协议层：自研 Node.js 实现。
  * IPC 通道：Renderer ↔ Main 通信。
* **运行器 (Worker 子进程)**：

  * 接收流程 JSON，逐步执行。
  * 通过 RPC 调用主进程串口 API。
  * 支持崩溃隔离与中止恢复。

### 3.2 协议层设计

* **串口通信**：serialport，支持断线重连与配置选项。
* **协议解析**：收发缓冲、帧边界、CRC 校验、超时/重试机制。
* **对象访问 API**：封装为路径访问（如 `axis0.controller.vel_limit`）。
* **错误处理**：串口级/协议级/设备级错误码统一。
* **MockDriver**：支持开发与测试。

### 3.3 流程运行器

* 运行器与主进程隔离，防止逻辑错误影响设备。
* IPC/RPC 批量调用降低通信成本。
* 运行日志：记录流程执行步骤、异常与结果文件。
* 错误处理：异常节点进入错误分支并切换到安全状态。

### 3.4 安全与保护

* **软限/硬限模板**：

  * 层级：驱动器模板 → 电机类型模板 → 项目模板。
  * 规则：

    * 超过软限：提示+可覆盖。
    * 超过硬限：拒绝写入。
* **急停机制**：UI 按钮+键盘快捷键 → 主进程直接下发 IDLE 状态。
* **上电默认**：设备初始为 Idle，不加载危险配置。

### 3.5 可视化采样策略

* **设备采样**：默认 200 Hz，上限 1 kHz。
* **IPC 推送**：默认 50 Hz，上限 100 Hz，批量 10–50 点。
* **前端刷新**：默认 30 FPS，上限 60 FPS。
* **历史缓冲**：默认 60s，可配置 10–300s。

---

## 4. 技术细节清单

### 4.1 API 接口（示例）

* `connect(port: string): Promise<DeviceHandle>`
* `disconnect(handle: DeviceHandle): Promise<void>`
* `read(path: string): Promise<any>`
* `write(path: string, value: any): Promise<void>`
* `requestState(state: string): Promise<void>`
* `stream(keys: string[], rateHz: number): Observable<Telemetry[]>`

### 4.2 节点参数（示例模板）

* 电气：`max_bus_voltage`, `max_phase_current`。
* 运动：`max_velocity`, `max_accel`, `ramp_rate`。
* 校准：`calib_current`。
* 热保护：`temp_guard`。

### 4.3 日志与数据管理

* 主进程日志：串口事件、错误信息。
* 运行器日志：流程执行步骤、节点状态。
* 导出文件：CSV/JSON，带固件版本、模板名、时间戳。

---

## 5. 开发与测试

* Mock 串口驱动支持端到端测试。
* Playwright + Mock 数据做 UI 自动化。
* 单元测试覆盖协议解析与 IPC 接口。
* 压力测试：高频采样、异常帧、丢包恢复。

---

## 6. 打包与发布

* **打包工具**：Electron-builder。
* **平台支持**：Windows/Linux/macOS。
* **更新机制**：electron-updater（可选）。

---

## 7. 后续待确认

1. 电机模板参数的默认值需基于实际电机/电源规格书标定。
2. 多语言支持优先级（默认中/英）。
3. 用户权限与安全确认机制（是否需要二次确认危险操作）。
